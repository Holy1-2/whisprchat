<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhisprChat Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Manrope:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .custom-brown { background-color: #1a120b; }
        .message-bubble { background-color: #2b2118; }
        .accent-brown { background-color: #3d2e20; }
        .text-light { color: #e5d5c6; }
        .font-manrope { font-family: 'Manrope', sans-serif; }
        
        @keyframes wave {
            0% { background-position: 0 0; }
            100% { background-position: 200% 0; }
        }
        .waveform {
            background: linear-gradient(90deg, #e5d5c6 20%, #3d2e20 50%, #e5d5c6 80%);
            background-size: 200% 100%;
            animation: wave 2s linear infinite;
            animation-play-state: paused;
        }
        
        .recording-overlay {
            background: rgba(26, 18, 11, 0.95);
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #2b2118; }
        ::-webkit-scrollbar-thumb { background: #3d2e20; border-radius: 3px; }
        
        .message-actions {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .message-bubble:hover .message-actions {
            opacity: 1;
        }
    </style>
</head>
<body class="custom-brown min-h-screen">
    <!-- Error Toast -->
    <div id="errorToast" class="hidden fixed top-4 left-1/2 -translate-x-1/2 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50"></div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-[#2b2118] p-6 rounded-xl max-w-md w-full mx-4">
            <h3 class="text-light text-xl font-manrope mb-4">Delete Message?</h3>
            <p class="text-light opacity-75 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-4">
                <button onclick="hideDeleteModal()" class="px-4 py-2 text-light hover:opacity-75">Cancel</button>
                <button onclick="confirmDelete()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Delete</button>
            </div>
        </div>
    </div>

    <!-- Recording Overlay -->
    <div id="recordingOverlay" class="hidden fixed inset-0 recording-overlay z-40 flex flex-col items-center justify-center">
        <div class="text-center">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                <span class="text-light text-xl">Recording</span>
                <span id="recordingTimer" class="text-light">0:00</span>
            </div>
            <button onclick="stopRecording()" class="p-6 rounded-full bg-red-500 hover:bg-red-600 transition-all">
                <i class="fa-solid fa-stop text-light text-2xl"></i>
            </button>
        </div>
    </div>

    <div class="container mx-auto max-w-2xl h-screen flex flex-col">
        <!-- Header -->
        <header class="p-4 flex items-center justify-between border-b-2 border-[#3d2e20] z-30">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <img src="mo.png" 
                         alt="Profile" 
                         class="w-10 h-10 rounded-full object-cover">
                    <div class="online-status rounded-full online"></div>
                </div>
                <div>
                    <h2 class="text-light font-manrope font-semibold">John Doe</h2>
                    <p class="text-xs text-[#e5d5c6] opacity-75 flex items-center gap-1">
                        <span class="online-status rounded-full online !static !w-2 !h-2"></span>
                        Online
                    </p>
                </div>
            </div>
            
            <div class="flex gap-4">
                <button class="text-light hover:text-[#e5d5c6] transition-colors">
                    <i class="fa-solid fa-sliders text-xl"></i>
                </button>
                <button class="text-light hover:text-[#e5d5c6] transition-colors">
                    <i class="fa-solid fa-ellipsis-vertical text-xl"></i>
                </button>
            </div>
        </header>
        <!-- Messages Area -->
        <div class="flex-1 overflow-y-auto p-4 space-y-4" id="messagesContainer">
            <!-- Demo Message -->
            <div class="flex items-start gap-3 justify-end group">
                <div class="message-bubble rounded-2xl p-4 max-w-[85%] accent-brown relative">
                    <div class="message-actions absolute -top-3 right-2 flex gap-2">
                        <button onclick="showDeleteModal(this)" class="p-2 bg-red-500 text-white rounded-full hover:bg-red-600">
                            <i class="fa-solid fa-trash text-xs w-4 h-4"></i>
                        </button>
                        <button onclick="replyToMessage(this)" class="p-2 bg-[#3d2e20] text-light rounded-full hover:bg-[#4f3e2e]">
                            <i class="fa-solid fa-reply text-xs w-4 h-4"></i>
                        </button>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="waveform w-32 h-6 rounded-lg opacity-75"></div>
                        <button class="play-button text-light hover:text-[#e5d5c6]" data-audio="">
                            <i class="fa-solid fa-play text-lg"></i>
                        </button>
                    </div>
                    <span class="text-xs text-[#e5d5c6] opacity-70 mt-2 block">0:15 • Just now</span>
                </div>
            </div>
        </div>

        <!-- Reply Preview -->
        <div id="replyPreview" class="hidden border-t border-[#3d2e20] p-3 bg-[#2b2118]">
            <div class="flex items-center justify-between">
                <div class="text-light text-sm">
                    <i class="fa-solid fa-reply mr-2 opacity-70"></i>
                    Replying to <span id="replyingTo" class="font-medium"></span>
                </div>
                <button onclick="cancelReply()" class="text-light hover:text-[#e5d5c6]">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </div>

        <!-- Input Section -->
        <footer class="p-4 border-t-2 border-[#3d2e20] relative">
            <div class="flex items-center justify-center gap-4">
                <button id="recordButton" 
                        class="p-5 rounded-full bg-[#3d2e20] hover:bg-[#4f3e2e] transition-all relative"
                        data-state="idle">
                    <i class="fa-solid fa-microphone text-light text-2xl"></i>
                </button>
            </div>
        </footer>
    </div>

    <script>
        class VoiceChatPro {
            constructor() {
                this.audioPlayer = new Audio();
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.recordingTime = 0;
                this.timerInterval = null;
                this.currentPlayback = null;
                this.currentReply = null;
                this.selectedMessageToDelete = null;
                
                this.initEventListeners();
            }

            initEventListeners() {
                document.getElementById('recordButton').addEventListener('click', () => this.toggleRecording());
                document.addEventListener('click', e => {
                    if (e.target.closest('.play-button')) {
                        this.togglePlayback(e.target.closest('.play-button'));
                    }
                });
            }

            async toggleRecording() {
                if (this.mediaRecorder?.state === 'recording') return;

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.startRecording(stream);
                    document.getElementById('recordingOverlay').classList.remove('hidden');
                } catch (err) {
                    this.showError('Microphone access required. Please enable permissions.');
                }
            }

            startRecording(stream) {
                this.mediaRecorder = new MediaRecorder(stream);
                this.audioChunks = [];
                this.recordingTime = 0;
                
                this.mediaRecorder.ondataavailable = e => this.audioChunks.push(e.data);
                this.mediaRecorder.onstop = () => this.handleRecordingStop();
                
                this.mediaRecorder.start();
                this.startTimer();
            }

            stopRecording() {
                if (this.mediaRecorder?.state === 'recording') {
                    this.mediaRecorder.stop();
                    clearInterval(this.timerInterval);
                    this.mediaRecorder.stream.getTracks().forEach(track => track.stop());
                    document.getElementById('recordingOverlay').classList.add('hidden');
                }
            }

            startTimer() {
                this.timerInterval = setInterval(() => {
                    this.recordingTime++;
                    const minutes = Math.floor(this.recordingTime / 60);
                    const seconds = this.recordingTime % 60;
                    document.getElementById('recordingTimer').textContent = 
                        `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);
            }

            handleRecordingStop() {
                const audioBlob = new Blob(this.audioChunks);
                const audioUrl = URL.createObjectURL(audioBlob);
                this.addVoiceMessage(audioUrl);
                this.currentReply = null;
                document.getElementById('replyPreview').classList.add('hidden');
            }

            addVoiceMessage(audioUrl) {
                const messagesContainer = document.getElementById('messagesContainer');
                const messageEl = document.createElement('div');
                const isReply = this.currentReply ? 'true' : 'false';
                const replyContent = this.currentReply ? 
                    `data-reply="${this.currentReply.dataset.messageId}"` : '';

                messageEl.className = 'flex items-start gap-3 justify-end group';
                messageEl.innerHTML = `
                    <div class="message-bubble rounded-2xl p-4 max-w-[85%] accent-brown relative" ${replyContent}>
                        ${this.getReplyBadge()}
                        <div class="message-actions absolute -top-3 right-2 flex gap-2">
                            <button onclick="showDeleteModal(this)" class="p-2 bg-red-500 text-white rounded-full hover:bg-red-600">
                                <i class="fa-solid fa-trash text-xs w-4 h-4"></i>
                            </button>
                            <button onclick="replyToMessage(this)" class="p-2 bg-[#3d2e20] text-light rounded-full hover:bg-[#4f3e2e]">
                                <i class="fa-solid fa-reply text-xs w-4 h-4"></i>
                            </button>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="waveform w-32 h-6 rounded-lg opacity-75"></div>
                            <button class="play-button text-light hover:text-[#e5d5c6]" data-audio="${audioUrl}">
                                <i class="fa-solid fa-play text-lg"></i>
                            </button>
                        </div>
                        <span class="text-xs text-[#e5d5c6] opacity-70 mt-2 block">
                            0:${this.recordingTime.toString().padStart(2, '0')} • Just now
                        </span>
                    </div>
                `;
                messagesContainer.prepend(messageEl);
            }

            getReplyBadge() {
                if (!this.currentReply) return '';
                return `
                    <div class="bg-[#3d2e20] p-2 rounded-lg mb-2 text-sm border-l-4 border-[#e5d5c6]">
                        <p class="text-light opacity-80 truncate">${this.currentReply.querySelector('p').textContent}</p>
                    </div>
                `;
            }

            togglePlayback(button) {
                if (this.currentPlayback === button) {
                    this.pausePlayback();
                } else {
                    if (this.currentPlayback) this.pausePlayback();
                    this.startPlayback(button);
                }
            }

            startPlayback(button) {
                const audioUrl = button.dataset.audio;
                this.audioPlayer.src = audioUrl;
                this.audioPlayer.play();
                button.innerHTML = '<i class="fa-solid fa-pause text-lg"></i>';
                button.closest('.message-bubble').querySelector('.waveform').style.animationPlayState = 'running';
                this.currentPlayback = button;
                
                this.audioPlayer.onended = () => this.pausePlayback();
            }

            pausePlayback() {
                this.audioPlayer.pause();
                if (this.currentPlayback) {
                    this.currentPlayback.innerHTML = '<i class="fa-solid fa-play text-lg"></i>';
                    this.currentPlayback.closest('.message-bubble').querySelector('.waveform').style.animationPlayState = 'paused';
                    this.currentPlayback = null;
                }
            }

            showError(message) {
                const errorEl = document.getElementById('errorToast');
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
                setTimeout(() => errorEl.classList.add('hidden'), 5000);
            }
        }

        // Global functions for UI interactions
        let voiceChat = new VoiceChatPro();
        let selectedMessageToDelete = null;

        function showDeleteModal(button) {
            selectedMessageToDelete = button.closest('.message-bubble');
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        function hideDeleteModal() {
            document.getElementById('deleteModal').classList.add('hidden');
        }

        function confirmDelete() {
            if (selectedMessageToDelete) {
                selectedMessageToDelete.closest('.flex').remove();
                hideDeleteModal();
            }
        }

        function replyToMessage(button) {
            const messageBubble = button.closest('.message-bubble');
            const content = messageBubble.querySelector('.waveform').nextElementSibling.dataset.audio;
            voiceChat.currentReply = messageBubble;
            
            document.getElementById('replyPreview').classList.remove('hidden');
            document.getElementById('replyingTo').textContent = 'Voice message';
        }

        function cancelReply() {
            voiceChat.currentReply = null;
            document.getElementById('replyPreview').classList.add('hidden');
        }

        function stopRecording() {
            voiceChat.stopRecording();
        }
    </script>
</body>
</html>